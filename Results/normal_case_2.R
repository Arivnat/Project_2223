####################################################################################
# Paper: Distributional conformal prediction
# Authors: V. Chernozhukov, K. Wuthrich, Y. Zhu,PNAS,118(48)
##Relevant github:
#https://github.com/kwuthrich/Replication_DCP
###################################################################################
####The above github is source material for the functions for the different 
###methods-DCP/DCP-QR,DCP-opt,CQR,CQR-m,CQR-r and CP-reg
#The functions for the methods, the function to create train,calibration
##and test data, the loop to check for singularity of the matrix as well 
##as well as the function for quantile bins have been taken from the github
##and used for this thesis.
#The rest of the code(data generation,setting up replications, additional plots,descriptive 
#analysis) has been written by me
########################################################################################
#######################################################################################
#########################################################
###loading required packages



library(xtable)
library(dplyr)
library(matrixcalc)
library(hdm)
library(quantreg)
library(Pareto)

normal<-function(n){
alpha.sig<-0.1
T.ho <- floor(n*0.2) ##20% holdout sample

#reps<-function(n,nsims,lpha.sig){
cov.mat <- leng.mat <- X.test.mat <-c<- NULL
cov.mat2 <- leng.mat2 <- X.test.mat2<-c2<- NULL
cov.mat3 <- leng.mat3 <- X.test.mat3 <- NULL
cov.mat4 <- leng.mat4 <- X.test.mat4 <- NULL
cov.mat5 <- leng.mat5 <- X.test.mat5 <- NULL
cov.mat6 <- leng.mat6 <- X.test.mat6 <- NULL
cov.mat7 <- leng.mat7 <- X.test.mat7 <- NULL
cov.mat8 <- leng.mat8 <- X.test.mat8 <- NULL
cov.mat9 <- leng.mat9 <- X.test.mat9 <- NULL
cov.mat10 <- leng.mat10<- X.test.mat10 <- NULL
cov.mat11 <- leng.mat11<- X.test.mat11 <- NULL
cov.mat12<- leng.mat12<- X.test.mat12 <- NULL
cov.mat13<- leng.mat13<- X.test.mat13<- NULL
cov.mat14<- leng.mat14 <- X.test.mat14 <- NULL
cov.mat15<- leng.mat15<- X.test.mat15 <- NULL

for (i in 1:1000){
  set.seed(i)
  x1<-rnorm(n,2,3)
  x2<-rnorm(n,4,2)
  res<-rnorm(n,0,1)
  eps<-res*sqrt(abs(x1))
  x<-cbind.data.frame(x1,x2)
  x<-as.matrix(x)
  y<-2+3.5*x1+2.5*x2+eps
  y2<-2+3.5*x1+2.5*x2+res
  ##different distributions for the error term
  y3<-2+3.5*x1+2.5*x2+rgamma(n,1,2)
  y4<-2+3.5*x1+2.5*x2+rgamma(n,2,2)
  y5<-2+3.5*x1+2.5*x2+rgamma(n,5,1)
  y6<-2+3.5*x1+2.5*x2+rgamma(n,7,3)
  ##student's t
  y7<-2+3.5*x1+2.5*x2+rt(n,2)
  y8<-2+3.5*x1+2.5*x2+rt(n,3)
  ##lognormal
  y9<-2+3.5*x1+2.5*x2+rlnorm(n,0,1)
  y10<-2+3.5*x1+2.5*x2+rlnorm(n,1,3)
  y11<-2+3.5*x1+2.5*x2+rlnorm(n,0,3)
  y12<-2+3.5*x1+2.5*x2+rlnorm(n,1,2)
  ##Pareto
  y13<-2+3.5*x1+2.5*x2+rPareto(n,1,2)
  y14<-2+3.5*x1+2.5*x2+rPareto(n,1,3)
  y15<-2+3.5*x1+2.5*x2+rPareto(n,2,3)

  
  sing <- sing2<-sing3<-sing4<-sing5<-sing6<-sing7<-sing8<-sing9<-sing10<-TRUE
  sing11 <- sing12<-sing13<-sing14<-sing15<-TRUE
  while (sing==TRUE){
    while (sing2==TRUE){
      while (sing3==TRUE){
        while (sing4==TRUE){
          while (sing5==TRUE){
            while (sing6==TRUE){
              while (sing7==TRUE){
                while (sing8==TRUE){
                  while (sing9==TRUE){
                    while (sing10==TRUE){
                      while (sing11==TRUE){
                        while (sing12==TRUE){
                          while (sing13==TRUE){
                            while (sing14==TRUE){
                              while (sing15==TRUE){
      
      ind <- sample(length(y),length(y),replace=FALSE)
      Y   <- y[ind]
      Y2   <- y2[ind]
      Y3   <- y3[ind]
      Y4   <- y4[ind]
      Y5   <- y5[ind]
      Y6   <- y6[ind]
      Y7   <- y7[ind]
      Y8   <- y8[ind]
      Y9   <- y9[ind]
      Y10   <- y10[ind]
      Y11   <- y11[ind]
      Y12  <- y12[ind]
      Y13  <- y13[ind]
      Y14   <- y14[ind]
      Y15  <- y15[ind]
      X   <- x[ind,]
      X   <- as.matrix(X)
      
      ind.test  <- (length(Y)-T.ho+1):length(Y)
      Y.test    <- Y[ind.test]
      X.test    <- cbind(X[ind.test,])
      
      ind.test2  <- (length(Y2)-T.ho+1):length(Y2)
      Y.test2    <- Y2[ind.test2]
      X.test2    <- cbind(X[ind.test2,])
      
      ind.test3  <- (length(Y3)-T.ho+1):length(Y3)
      Y.test3    <- Y3[ind.test3]
      X.test3    <- cbind(X[ind.test3,])
      
      
      ind.test4  <- (length(Y4)-T.ho+1):length(Y4)
      Y.test4  <- Y4[ind.test2]
      X.test4    <- cbind(X[ind.test4,])
      
      ind.test5  <- (length(Y5)-T.ho+1):length(Y5)
      Y.test5    <- Y5[ind.test2]
      X.test5    <- cbind(X[ind.test5,])
      
      ind.test6  <- (length(Y6)-T.ho+1):length(Y6)
      Y.test6    <- Y6[ind.test6]
      X.test6    <- cbind(X[ind.test6,])
      
      
      ind.test7  <- (length(Y7)-T.ho+1):length(Y7)
      Y.test7    <- Y7[ind.test7]
      X.test7    <- cbind(X[ind.test7,])
      
      ind.test8  <- (length(Y8)-T.ho+1):length(Y8)
      Y.test8    <- Y8[ind.test8]
      X.test8    <- cbind(X[ind.test8,])
      
      ind.test9  <- (length(Y9)-T.ho+1):length(Y9)
      Y.test9   <- Y9[ind.test9]
      X.test9   <- cbind(X[ind.test9,])
      
      ind.test10  <- (length(Y10)-T.ho+1):length(Y10)
      Y.test10   <- Y10[ind.test10]
      X.test10    <- cbind(X[ind.test10,])
      
      ind.test11  <- (length(Y11)-T.ho+1):length(Y11)
      Y.test11    <- Y11[ind.test11]
      X.test11    <- cbind(X[ind.test11,])
      
      ind.test12  <- (length(Y12)-T.ho+1):length(Y12)
      Y.test12   <- Y12[ind.test12]
      X.test12    <- cbind(X[ind.test12,])
      
      ind.test13  <- (length(Y13)-T.ho+1):length(Y13)
      Y.test13    <- Y13[ind.test13]
      X.test13    <- cbind(X[ind.test13,])
      
      ind.test14  <- (length(Y14)-T.ho+1):length(Y14)
      Y.test14   <- Y14[ind.test14]
      X.test14   <- cbind(X[ind.test14,])
      
      ind.test15  <- (length(Y15)-T.ho+1):length(Y15)
      Y.test15    <- Y15[ind.test15]
      X.test15    <- cbind(X[ind.test15,])
      
      obj.uneven <- aux.uneven(Y[-ind.test],cbind(X[-ind.test,]))
      obj.uneven2 <- aux.uneven(Y2[-ind.test2],cbind(X[-ind.test2,]))
      obj.uneven3 <- aux.uneven(Y3[-ind.test3],cbind(X[-ind.test3,]))
      obj.uneven4 <- aux.uneven(Y4[-ind.test4],cbind(X[-ind.test4,]))
      obj.uneven5 <- aux.uneven(Y5[-ind.test5],cbind(X[-ind.test5,]))
      obj.uneven6 <- aux.uneven(Y6[-ind.test6],cbind(X[-ind.test6,]))
      obj.uneven7 <- aux.uneven(Y7[-ind.test7],cbind(X[-ind.test7,]))
      obj.uneven8 <- aux.uneven(Y8[-ind.test8],cbind(X[-ind.test8,]))
      obj.uneven9 <- aux.uneven(Y9[-ind.test9],cbind(X[-ind.test9,]))
      obj.uneven10 <- aux.uneven(Y10[-ind.test10],cbind(X[-ind.test10,]))
      obj.uneven11 <- aux.uneven(Y11[-ind.test11],cbind(X[-ind.test11,]))
      obj.uneven12 <- aux.uneven(Y12[-ind.test12],cbind(X[-ind.test12,]))
      obj.uneven13 <- aux.uneven(Y13[-ind.test13],cbind(X[-ind.test13,]))
      obj.uneven14 <- aux.uneven(Y14[-ind.test14],cbind(X[-ind.test14,]))
      obj.uneven15 <- aux.uneven(Y15[-ind.test15],cbind(X[-ind.test15,]))
      
      Xa <- cbind(obj.uneven$X0)
      Ya<- obj.uneven$Y0
      X1a <- cbind(obj.uneven$X1)
      Y1a <- obj.uneven$Y1
      
      X02 <- cbind(obj.uneven2$X0)
      Y02 <- obj.uneven2$Y0
      X12 <- cbind(obj.uneven2$X1)
      Y12 <- obj.uneven2$Y1
      
      X03 <- cbind(obj.uneven3$X0)
      Y03 <- obj.uneven3$Y0
      X13<- cbind(obj.uneven3$X1)
      Y13 <- obj.uneven3$Y1
      
      X04 <- cbind(obj.uneven4$X0)
      Y04 <- obj.uneven4$Y0
      X14<- cbind(obj.uneven4$X1)
      Y14 <- obj.uneven4$Y1
      
      X05 <- cbind(obj.uneven5$X0)
      Y05 <- obj.uneven5$Y0
      X15<- cbind(obj.uneven5$X1)
      Y15 <- obj.uneven5$Y1
      
      X06 <- cbind(obj.uneven6$X0)
      Y06 <- obj.uneven6$Y0
      X16<- cbind(obj.uneven6$X1)
      Y16 <- obj.uneven6$Y1
      
      X07 <- cbind(obj.uneven7$X0)
      Y07 <- obj.uneven7$Y0
      X17<- cbind(obj.uneven7$X1)
      Y17 <- obj.uneven7$Y1
      
      X08 <- cbind(obj.uneven8$X0)
      Y08 <- obj.uneven8$Y0
      X18<- cbind(obj.uneven8$X1)
      Y18 <- obj.uneven8$Y1
      
      X09 <- cbind(obj.uneven9$X0)
      Y09 <- obj.uneven9$Y0
      X19<- cbind(obj.uneven9$X1)
      Y19 <- obj.uneven9$Y1
      
      X10 <- cbind(obj.uneven10$X0)
      Y10 <- obj.uneven10$Y0
      X110<- cbind(obj.uneven10$X1)
      Y110 <- obj.uneven10$Y1
      
      X11 <- cbind(obj.uneven11$X0)
      Y11 <- obj.uneven11$Y0
      X111<- cbind(obj.uneven11$X1)
      Y111 <- obj.uneven11$Y1
      
      X12 <- cbind(obj.uneven12$X0)
      Y12 <- obj.uneven12$Y0
      X112<- cbind(obj.uneven12$X1)
      Y112 <- obj.uneven12$Y1
      
      X13 <- cbind(obj.uneven13$X0)
      Y13 <- obj.uneven13$Y0
      X113<- cbind(obj.uneven13$X1)
      Y113 <- obj.uneven13$Y1
      
      X14 <- cbind(obj.uneven14$X0)
      Y14 <- obj.uneven14$Y0
      X114<- cbind(obj.uneven14$X1)
      Y114 <- obj.uneven14$Y1
      
      X15 <- cbind(obj.uneven15$X0)
      Y15 <- obj.uneven15$Y0
      X115<- cbind(obj.uneven15$X1)
      Y115 <- obj.uneven15$Y1
      
      sing  <- is.singular.matrix(t(Xa)%*%Xa)
      sing2  <- is.singular.matrix(t(X02)%*%X02)
      sing3  <- is.singular.matrix(t(X03)%*%X03)
      sing4  <- is.singular.matrix(t(X04)%*%X04)
      sing5  <- is.singular.matrix(t(X05)%*%X05)
      sing6  <- is.singular.matrix(t(X06)%*%X06)
      sing7  <- is.singular.matrix(t(X07)%*%X07)
      sing8  <- is.singular.matrix(t(X08)%*%X08)
      sing9  <- is.singular.matrix(t(X09)%*%X09)
      sing10  <- is.singular.matrix(t(X10)%*%X10)
      sing11 <- is.singular.matrix(t(X11)%*%X11)
      sing12 <- is.singular.matrix(t(X12)%*%X12)
      sing13 <- is.singular.matrix(t(X13)%*%X13)
      sing14 <- is.singular.matrix(t(X14)%*%X14)
      sing15  <- is.singular.matrix(t(X15)%*%X15)
      
    }
  }
}
                        }
                      }
                    }
                  }
                }
              }
            }
          }
        }
      }
    }
  }
                          
  
  taus    <- seq(0.001,0.999,length=200)
 # ys      <- quantile(unique(c(Y0,Y1)),seq(0.001,0.999,length=200))
#  ys2      <- quantile(unique(c(Y02,Y12)),seq(0.001,0.999,length=200))
  
  # Applying the difference conformal prediction methods
  res.qr    <- dcp.qr(Ya,Xa,Y1a,X1a,Y.test,X.test,taus,alpha.sig)
  res.qro<-dcp.opt(Ya,Xa,Y1a,X1a,Y.test,X.test,taus,alpha.sig)
  res.cqr   <- cqr(Ya,Xa,Y1a,X1a,Y.test,X.test,alpha.sig)
  res.reg   <- cp.reg(Ya,Xa,Y1a,X1a,Y.test,X.test,alpha.sig)
  
  res.qr2    <- dcp.qr(Y02,X02,Y12,X12,Y.test2,X.test2,taus,alpha.sig)
  res.qro2<-dcp.opt(Y02,X02,Y12,X12,Y.test2,X.test2,taus,alpha.sig)
  res.cqr2   <- cqr(Y02,X02,Y12,X12,Y.test2,X.test2,alpha.sig)
  res.reg2   <- cp.reg(Y02,X02,Y12,X12,Y.test2,X.test2,alpha.sig)
  
  res.qr3    <- dcp.qr(Y03,X03,Y13,X13,Y.test3,X.test3,taus,alpha.sig)
  res.qro3<-dcp.opt(Y03,X03,Y13,X13,Y.test3,X.test3,taus,alpha.sig)
  res.cqr3   <- cqr(Y03,X03,Y13,X13,Y.test3,X.test3,alpha.sig)
  res.reg3   <- cp.reg(Y03,X03,Y13,X13,Y.test3,X.test3,alpha.sig)
  
  
  res.qr4    <- dcp.qr(Y04,X04,Y14,X14,Y.test4,X.test4,taus,alpha.sig)
  res.qro4<-dcp.opt(Y04,X04,Y14,X14,Y.test4,X.test4,taus,alpha.sig)
  res.cqr4   <- cqr(Y04,X04,Y14,X14,Y.test4,X.test4,alpha.sig)
  res.reg4   <- cp.reg(Y04,X04,Y14,X14,Y.test2,X.test4,alpha.sig)
  
  res.qr5    <- dcp.qr(Y05,X05,Y15,X15,Y.test5,X.test5,taus,alpha.sig)
  res.qro5<-dcp.opt(Y05,X05,Y15,X15,Y.test5,X.test5,taus,alpha.sig)
  res.cqr5   <- cqr(Y05,X05,Y15,X15,Y.test5,X.test5,alpha.sig)
  res.reg5   <- cp.reg(Y05,X05,Y15,X15,Y.test5,X.test5,alpha.sig)
  
  res.qr6    <- dcp.qr(Y06,X06,Y16,X16,Y.test6,X.test6,taus,alpha.sig)
  res.qro6<-dcp.opt(Y06,X06,Y16,X16,Y.test6,X.test6,taus,alpha.sig)
  res.cqr6   <- cqr(Y06,X06,Y16,X16,Y.test6,X.test6,alpha.sig)
  res.reg6   <- cp.reg(Y06,X06,Y16,X16,Y.test6,X.test6,alpha.sig)
  
  res.qr7    <- dcp.qr(Y07,X07,Y17,X17,Y.test7,X.test7,taus,alpha.sig)
  res.qro7<-dcp.opt(Y07,X07,Y17,X17,Y.test7,X.test7,taus,alpha.sig)
  res.cqr7   <- cqr(Y07,X07,Y17,X17,Y.test7,X.test7,alpha.sig)
  res.reg7   <- cp.reg(Y07,X07,Y17,X17,Y.test7,X.test7,alpha.sig)
  
  res.qr8    <- dcp.qr(Y08,X08,Y18,X18,Y.test8,X.test8,taus,alpha.sig)
  res.qro8<-dcp.opt(Y08,X08,Y18,X18,Y.test8,X.test8,taus,alpha.sig)
  res.cqr8   <- cqr(Y08,X08,Y18,X18,Y.test8,X.test8,alpha.sig)
  res.reg8   <- cp.reg(Y08,X08,Y18,X18,Y.test8,X.test8,alpha.sig)
  
  res.qr9    <- dcp.qr(Y09,X09,Y19,X19,Y.test9,X.test9,taus,alpha.sig)
  res.qro9<-dcp.opt(Y09,X09,Y19,X19,Y.test9,X.test9,taus,alpha.sig)
  res.cqr9   <- cqr(Y09,X09,Y19,X19,Y.test9,X.test9,alpha.sig)
  res.reg9   <- cp.reg(Y09,X09,Y19,X19,Y.test9,X.test9,alpha.sig)
  
  res.qr10    <- dcp.qr(Y10,X10,Y110,X110,Y.test10,X.test10,taus,alpha.sig)
  res.qro10<-dcp.opt(Y10,X10,Y110,X110,Y.test10,X.test10,taus,alpha.sig)
  res.cqr10  <- cqr(Y10,X10,Y110,X110,Y.test10,X.test10,alpha.sig)
  res.reg10  <- cp.reg(Y10,X10,Y110,X110,Y.test10,X.test10,alpha.sig)
  
  res.qr11    <- dcp.qr(Y11,X11,Y111,X111,Y.test11,X.test11,taus,alpha.sig)
  res.qro11<-dcp.opt(Y11,X11,Y111,X111,Y.test11,X.test11,taus,alpha.sig)
  res.cqr11  <- cqr(Y11,X11,Y111,X111,Y.test11,X.test11,alpha.sig)
  res.reg11  <- cp.reg(Y11,X11,Y111,X111,Y.test11,X.test11,alpha.sig)
  
  res.qr12    <- dcp.qr(Y12,X12,Y112,X112,Y.test12,X.test12,taus,alpha.sig)
  res.qro12<-dcp.opt(Y12,X12,Y112,X112,Y.test12,X.test12,taus,alpha.sig)
  res.cqr12  <- cqr(Y12,X12,Y112,X112,Y.test12,X.test12,alpha.sig)
  res.reg12  <- cp.reg(Y12,X12,Y112,X112,Y.test12,X.test12,alpha.sig)
  
  res.qr13    <- dcp.qr(Y13,X13,Y113,X113,Y.test13,X.test13,taus,alpha.sig)
  res.qro13<-dcp.opt(Y13,X13,Y113,X113,Y.test13,X.test13,taus,alpha.sig)
  res.cqr13  <- cqr(Y13,X13,Y113,X113,Y.test13,X.test13,alpha.sig)
  res.reg13  <- cp.reg(Y13,X13,Y113,X113,Y.test13,X.test13,alpha.sig)
  
  res.qr14    <- dcp.qr(Y14,X14,Y114,X114,Y.test14,X.test14,taus,alpha.sig)
  res.qro14<-dcp.opt(Y14,X14,Y114,X114,Y.test14,X.test14,taus,alpha.sig)
  res.cqr14  <- cqr(Y14,X14,Y114,X114,Y.test14,X.test14,alpha.sig)
  res.reg14  <- cp.reg(Y14,X14,Y114,X114,Y.test14,X.test14,alpha.sig)
  
  res.qr15    <- dcp.qr(Y15,X15,Y115,X115,Y.test15,X.test15,taus,alpha.sig)
  res.qro15<-dcp.opt(Y15,X15,Y115,X115,Y.test15,X.test15,taus,alpha.sig)
  res.cqr15  <- cqr(Y15,X15,Y115,X115,Y.test15,X.test15,alpha.sig)
  res.reg15  <- cp.reg(Y15,X15,Y115,X115,Y.test15,X.test15,alpha.sig)
  
  X.test.mat <- rbind(X.test.mat,X.test)
  X.test.mat2 <- rbind(X.test.mat2,X.test2)
  X.test.mat3 <- rbind(X.test.mat3,X.test3)
  X.test.mat4 <- rbind(X.test.mat4,X.test4)
  X.test.mat5 <- rbind(X.test.mat5,X.test5)
  X.test.mat6 <- rbind(X.test.mat6,X.test6)
  X.test.mat7 <- rbind(X.test.mat7,X.test7)
  X.test.mat8 <- rbind(X.test.mat8,X.test8)
  X.test.mat9<- rbind(X.test.mat9,X.test9)
  X.test.mat10 <- rbind(X.test.mat10,X.test10)
  X.test.mat11<- rbind(X.test.mat11,X.test11)
  X.test.mat12<- rbind(X.test.mat12,X.test12)
  X.test.mat13<- rbind(X.test.mat13,X.test13)
  X.test.mat14<- rbind(X.test.mat14,X.test14)
  X.test.mat15<- rbind(X.test.mat15,X.test15)
  
  cov.mat.temp  <- cbind(res.qr$cov.qr,res.qro$cov.opt,res.cqr$cov.o,res.cqr$cov.m,res.cqr$cov.r,res.reg$cov.reg)
  leng.mat.temp <- cbind(res.qr$leng.qr,res.qro$leng.opt,res.cqr$leng.o,res.cqr$leng.m,res.cqr$leng.r,res.reg$leng.reg)
  
  cov.mat.temp2  <- cbind(res.qr2$cov.qr,res.qro2$cov.opt,res.cqr2$cov.o,res.cqr2$cov.m,res.cqr2$cov.r,res.reg2$cov.reg)
  leng.mat.temp2 <- cbind(res.qr2$leng.qr,res.qro2$leng.opt,res.cqr2$leng.o,res.cqr2$leng.m,res.cqr2$leng.r,res.reg2$leng.reg)
  
  cov.mat.temp3  <- cbind(res.qr3$cov.qr,res.qro3$cov.opt,res.cqr3$cov.o,res.cqr3$cov.m,res.cqr3$cov.r,res.reg3$cov.reg)
  leng.mat.temp3 <- cbind(res.qr3$leng.qr,res.qro3$leng.opt,res.cqr3$leng.o,res.cqr3$leng.m,res.cqr3$leng.r,res.reg3$leng.reg)
  
  cov.mat.temp4 <- cbind(res.qr4$cov.qr,res.qro4$cov.opt,res.cqr4$cov.o,res.cqr4$cov.m,res.cqr4$cov.r,res.reg4$cov.reg)
  leng.mat.temp4 <- cbind(res.qr4$leng.qr,res.qro4$leng.opt,res.cqr4$leng.o,res.cqr4$leng.m,res.cqr4$leng.r,res.reg4$leng.reg)
  
  cov.mat.temp5 <- cbind(res.qr5$cov.qr,res.qro5$cov.opt,res.cqr5$cov.o,res.cqr5$cov.m,res.cqr5$cov.r,res.reg5$cov.reg)
  leng.mat.temp5 <- cbind(res.qr5$leng.qr,res.qro5$leng.opt,res.cqr5$leng.o,res.cqr5$leng.m,res.cqr5$leng.r,res.reg5$leng.reg)
  
  cov.mat.temp6 <- cbind(res.qr6$cov.qr,res.qro6$cov.opt,res.cqr6$cov.o,res.cqr6$cov.m,res.cqr6$cov.r,res.reg6$cov.reg)
  leng.mat.temp6 <- cbind(res.qr6$leng.qr,res.qro6$leng.opt,res.cqr6$leng.o,res.cqr6$leng.m,res.cqr6$leng.r,res.reg6$leng.reg)
  
  cov.mat.temp7 <- cbind(res.qr7$cov.qr,res.qro7$cov.opt,res.cqr7$cov.o,res.cqr7$cov.m,res.cqr7$cov.r,res.reg7$cov.reg)
  leng.mat.temp7 <- cbind(res.qr7$leng.qr,res.qro7$leng.opt,res.cqr7$leng.o,res.cqr7$leng.m,res.cqr7$leng.r,res.reg7$leng.reg)
  
  cov.mat.temp8 <- cbind(res.qr8$cov.qr,res.qro8$cov.opt,res.cqr8$cov.o,res.cqr8$cov.m,res.cqr8$cov.r,res.reg8$cov.reg)
  leng.mat.temp8 <- cbind(res.qr8$leng.qr,res.qro8$leng.opt,res.cqr8$leng.o,res.cqr8$leng.m,res.cqr8$leng.r,res.reg8$leng.reg)

  
  cov.mat.temp9 <- cbind(res.qr9$cov.qr,res.qro9$cov.opt,res.cqr9$cov.o,res.cqr9$cov.m,res.cqr9$cov.r,res.reg9$cov.reg)
  leng.mat.temp9 <- cbind(res.qr9$leng.qr,res.qro9$leng.opt,res.cqr9$leng.o,res.cqr9$leng.m,res.cqr9$leng.r,res.reg9$leng.reg)
  
  cov.mat.temp10 <- cbind(res.qr10$cov.qr,res.qro10$cov.opt,res.cqr10$cov.o,res.cqr10$cov.m,res.cqr10$cov.r,res.reg10$cov.reg)
  leng.mat.temp10 <- cbind(res.qr10$leng.qr,res.qro10$leng.opt,res.cqr10$leng.o,res.cqr10$leng.m,res.cqr10$leng.r,res.reg10$leng.reg)
  
  cov.mat.temp11<- cbind(res.qr11$cov.qr,res.qro11$cov.opt,res.cqr11$cov.o,res.cqr11$cov.m,res.cqr11$cov.r,res.reg11$cov.reg)
  leng.mat.temp11 <- cbind(res.qr11$leng.qr,res.qro11$leng.opt,res.cqr11$leng.o,res.cqr11$leng.m,res.cqr11$leng.r,res.reg11$leng.reg)
  
  cov.mat.temp12 <- cbind(res.qr12$cov.qr,res.qro12$cov.opt,res.cqr12$cov.o,res.cqr12$cov.m,res.cqr12$cov.r,res.reg12$cov.reg)
  leng.mat.temp12 <- cbind(res.qr12$leng.qr,res.qro12$leng.opt,res.cqr12$leng.o,res.cqr12$leng.m,res.cqr12$leng.r,res.reg12$leng.reg)
  
  cov.mat.temp13 <- cbind(res.qr13$cov.qr,res.qro13$cov.opt,res.cqr13$cov.o,res.cqr13$cov.m,res.cqr13$cov.r,res.reg13$cov.reg)
  leng.mat.temp13 <- cbind(res.qr13$leng.qr,res.qro13$leng.opt,res.cqr13$leng.o,res.cqr13$leng.m,res.cqr13$leng.r,res.reg13$leng.reg)
  
  cov.mat.temp14 <- cbind(res.qr14$cov.qr,res.qro14$cov.opt,res.cqr14$cov.o,res.cqr14$cov.m,res.cqr14$cov.r,res.reg14$cov.reg)
  leng.mat.temp14 <- cbind(res.qr14$leng.qr,res.qro14$leng.opt,res.cqr14$leng.o,res.cqr14$leng.m,res.cqr14$leng.r,res.reg14$leng.reg)
  
  cov.mat.temp15 <- cbind(res.qr15$cov.qr,res.qro15$cov.opt,res.cqr15$cov.o,res.cqr15$cov.m,res.cqr15$cov.r,res.reg15$cov.reg)
  leng.mat.temp15 <- cbind(res.qr15$leng.qr,res.qro15$leng.opt,res.cqr15$leng.o,res.cqr15$leng.m,res.cqr15$leng.r,res.reg15$leng.reg)
  
  cov.mat   <- rbind(cov.mat,cov.mat.temp)
  leng.mat  <- rbind(leng.mat,leng.mat.temp)
  
  cov.mat2   <- rbind(cov.mat2,cov.mat.temp2)
  leng.mat2  <- rbind(leng.mat2,leng.mat.temp2)
  
  cov.mat3   <- rbind(cov.mat3,cov.mat.temp3)
  leng.mat3 <- rbind(leng.mat3,leng.mat.temp3)
  
  cov.mat4   <- rbind(cov.mat4,cov.mat.temp4)
  leng.mat4  <- rbind(leng.mat4,leng.mat.temp4)
  
  cov.mat5   <- rbind(cov.mat5,cov.mat.temp5)
  leng.mat5  <- rbind(leng.mat5,leng.mat.temp5)
  
  cov.mat6   <- rbind(cov.mat6,cov.mat.temp6)
  leng.mat6  <- rbind(leng.mat6,leng.mat.temp6)
  
  cov.mat7   <- rbind(cov.mat7,cov.mat.temp7)
  leng.mat7  <- rbind(leng.mat7,leng.mat.temp7)
  
  cov.mat8   <- rbind(cov.mat8,cov.mat.temp8)
  leng.mat8  <- rbind(leng.mat8,leng.mat.temp8)
  
  cov.mat9   <- rbind(cov.mat9,cov.mat.temp9)
  leng.mat9  <- rbind(leng.mat9,leng.mat.temp9)
  
  cov.mat10   <- rbind(cov.mat10,cov.mat.temp10)
  leng.mat10  <- rbind(leng.mat10,leng.mat.temp10)
  
  cov.mat11   <- rbind(cov.mat11,cov.mat.temp11)
  leng.mat11  <- rbind(leng.mat11,leng.mat.temp11)
  
  cov.mat12 <- rbind(cov.mat12,cov.mat.temp12)
  leng.mat12  <- rbind(leng.mat12,leng.mat.temp12)
  
  cov.mat13 <- rbind(cov.mat13,cov.mat.temp13)
  leng.mat13  <- rbind(leng.mat13,leng.mat.temp13)
  
  cov.mat14 <- rbind(cov.mat14,cov.mat.temp14)
  leng.mat14  <- rbind(leng.mat14,leng.mat.temp14)
  
  cov.mat15 <- rbind(cov.mat15,cov.mat.temp15)
  leng.mat15  <- rbind(leng.mat15,leng.mat.temp15)
  }




l<-list(leng.mat,leng.mat2,leng.mat3,leng.mat4,leng.mat5,leng.mat6,leng.mat7,leng.mat8,leng.mat9,leng.mat10,leng.mat11,
        leng.mat12,leng.mat13,leng.mat14,leng.mat15,
        cov.mat,cov.mat2,cov.mat3,cov.mat4,cov.mat5,cov.mat6,cov.mat7,cov.mat8,
        cov.mat9,cov.mat10,cov.mat11,cov.mat12,cov.mat13,cov.mat14,cov.mat15,
        X.test.mat,X.test.mat2,X.test.mat3,X.test.mat4,X.test.mat5,X.test.mat6,
        X.test.mat7,X.test.mat8,X.test.mat9,X.test.mat10,X.test.mat11,X.test.mat12,
        X.test.mat13,X.test.mat14,X.test.mat15)
return(l)
}

start<-Sys.time()
na<-normal(50)
Sys.time()

start<-Sys.time()
nb<-normal(70) ##X14.02163   13.1253 mins
Sys.time()-start

start<-Sys.time()
n1<-normal(100) ##Warning msg-glm  ##Time difference of 23.82725 mins
Sys.time()-start
##glm.fit did not converge error-https://www.statology.org/glm-fit-algorithm-did-not-converge/

##to do:
start<-Sys.time()
n2<-normal(200) ####
Sys.time()-start

start<-Sys.time()
n3<-normal(300)
Sys.time()-start ###40.46748 mins

start<-Sys.time()
n4<-normal(500)  ###Time difference of 1.340761 hours
Sys.time()-start

##########Do data manipulations now-get latex tables#####################################
###While get latex tables-run 300 in another R session##################################

###function to get average coverage ###############################################
avgc<-function(md){   ##md can be n4,n3,etc...
avgcov<-NULL
for (i in 16:30){
  md2<-data.frame(md[i])
  ac<-colMeans(md2,na.rm=TRUE)
  avgcov<-rbind(avgcov,ac)
}
row1<-c("(1)","(2)","(3)","(4)","(5)","(6)","(7)","(8)",
        "(9)","(10)","(11)","(12)","(13)","(14)","(15)")
avgcov<-cbind.data.frame(row1,avgcov)
names(avgcov)<-c("Type","DCP-QR","DCP-opt","CQR","CQR-m","CQR-r","CP-reg")
#a<-xtable(avgcov)
return(avgcov)
}

q<-avgc(na)
r<-avgc(nb)
s<-avgc(n1)
t<-avgc(n2)
u<-avgc(n3)
v<-avgc(n4)

datn<-rbind.data.frame(q,r,s,t,u,v)
xtable(datn,digits=3)
###Similarly function for average length
avgl<-function(md){   ##md can be n4,n3,etc...
  avglen<-NULL
  for (i in 1:15){
    md2<-data.frame(md[i])
    ac<-colMeans(md2,na.rm=TRUE)
    avglen<-rbind(avglen,ac)
  }
  row1<-c("(1)","(2)","(3)","(4)","(5)","(6)","(7)","(8)",
          "(9)","(10)","(11)","(12)","(13)","(14)","(15)")
  avglen<-cbind.data.frame(row1,avglen)
  names(avglen)<-c("Type","DCP-QR","DCP-opt","CQR","CQR-m","CQR-r","CP-reg")
  #a<-xtable(avglen)
  return(avglen)
}
q0<-avgl(na)
r0<-avgl(nb)
s0<-avgl(n1)
t0<-avgl(n2)
u0<-avgl(n3)
v0<-avgl(n4)

datl<-rbind.data.frame(q0,r0,s0,t0,u0,v0)
xtable(datl,digits=3)

sd1<-function(md){
sdm<-NULL
for (i in 16:30){
   cov<-data.frame(md[i])
   xmat<-as.matrix(data.frame(md[i+15]))
   pred.cov.qr       <- predict(glm(cov[,1]~xmat,family=binomial(link="logit")),type="response")
   pred.cov.opt      <- predict(glm(cov[,2]~xmat,family=binomial(link="logit")),type="response")
   pred.cov.cqr.o    <- predict(glm(cov[,3]~xmat,family=binomial(link="logit")),type="response")
   pred.cov.cqr.m    <- predict(glm(cov[,4]~xmat,family=binomial(link="logit")),type="response")
   pred.cov.cqr.r    <- predict(glm(cov[,5]~xmat,family=binomial(link="logit")),type="response")
   pred.cov.reg      <- predict(glm(cov[,6]~xmat,family=binomial(link="logit")),type="response")
   #pred.cov.loc      <- predict(glm(cov.mat[,8]~X.test.mat,family=binomial(link="logit")),type="response")
   pred.cov<-cbind.data.frame(pred.cov.qr,pred.cov.opt,pred.cov.cqr.o,pred.cov.cqr.m,pred.cov.cqr.r,pred.cov.reg)
   res.cov.cond <- apply(pred.cov,2,sd)
   sdm<-rbind(sdm,res.cov.cond)
}
sdm<-data.frame(sdm)
names(sdm)<-c("DCP-QR","DCP-opt","CQR","CQR-m","CQR-r","CP-reg")
return(sdm)
}

a<-sd1(na)
b<-sd1(nb)
c<-sd1(n1)
d<-sd1(n2)
e<-sd1(n3)
f<-sd1(n4)

datsd<-rbind.data.frame(a,b,c,d,e,f)
formatn<-function(x){
  #if (x>0.09){y=x}
  #else {y=formatC(x,format="e",digits=2)}
  y<-ifelse(abs(x)>=0.01,round(x,4),formatC(x,format="e",digits=2))
  return(y)
}
datsd[]<-lapply(datsd,formatn)
xtable(datsd,digits=3)
#avgc(n4)
#avgl(n4)

##########empirical avg. coverage and avg.length per iteration(computed 
##over sample generated in each iteration)
###

##n4[31]-X.test.mat, n5[32]-X.test.mat2,....

##n<-100, m<-n4[16]  s<-1000

###This gives no NA's
##EMPIRICAL COVERAGE
for (i in 16:30){
        g<-data.frame(n4[i])
        g1<-data.frame(aggregate(g, list(rep(1:(nrow(g) %/% n + 1), each = n, len = nrow(g))), mean)[-1])
        g1$type<-i-15
        g1$type<-as.character(g1$type)
        names(g1)<-c("DCP-QR","DCP-opt","CQR","CQR-m","CQR-r","CP-reg","i")
        assign(paste("EC",i,sep=""),g1)
}

##EMPIRICAL LENGTH
for (i in 1:15){
  g<-data.frame(n4[i])
  g1<-data.frame(aggregate(g, list(rep(1:(nrow(g) %/% n + 1), each = n, len = nrow(g))), mean)[-1])
  g1$i<-i
  g1$i<-as.character(g1$i)
  names(g1)<-c("DCP-QR","DCP-opt","CQR","CQR-m","CQR-r","CP-reg","i")
  assign(paste("NL",i,sep=""),g1)
}

##EMP.COVERAGE BOXPLOT
df_three <- rbind(EC16,EC17,EC18)
df_six <- rbind(EC19,EC20,EC21)
df_nine <- rbind(EC22,EC23,EC24)
df_twelve <- rbind(EC25,EC26,EC27)
df_fifteen <- rbind(EC28,EC29,EC30)

##EMP.LENGTH BOXPLOT
df_three2 <- rbind(NL1,NL2,NL3)
df_six2 <- rbind(NL4,NL5,NL6)
df_nine2 <- rbind(NL7,NL8,NL9)
df_twelve2 <- rbind(NL10,NL11,NL12)
df_fifteen2 <- rbind(NL13,NL14,NL15)

library(reshape2)
library(ggplot2)
meltedf1 <- melt(df_three, id.var="i")
meltedf2 <- melt(df_six, id.var="i")
meltedf3 <- melt(df_nine, id.var="i")
meltedf4 <- melt(df_twelve, id.var="i")
meltedf5 <- melt(df_fifteen, id.var="i")

###Plotting
plotbp<-function(df){
  b1<-ggplot(df, aes(x=i, y=value)) + geom_boxplot(aes(fill=variable),outlier.size=0.5)+
    geom_hline(yintercept=0.9,col="red",size=1)+scale_fill_brewer(palette="Spectral")+
    xlab("Error Type")+ylab("Per-iteration Average Coverage")
    return(b1)
}
a<-plotbp(meltedf1)
b<-plotbp(meltedf2)
c<-plotbp(meltedf3)
d<-plotbp(meltedf4)
e<-plotbp(meltedf5)
 
library(cowplot)
plot_grid(
  a, b,c,d,e,
  align = "h", axis = "tb",
  nrow = 3, rel_widths = c(2,2)
)



##https://stackoverflow.com/questions/45150841/boxplots-from-two-dataframes-in-r

###EMPIRICAL LENGTH
meltedf12 <- melt(df_three2, id.var="i")
meltedf22 <- melt(df_six2, id.var="i")
meltedf32 <- melt(df_nine2, id.var="i")
meltedf42 <- melt(df_twelve2, id.var="i")
meltedf52 <- melt(df_fifteen2, id.var="i")

###Plotting
plotbp2<-function(df){
  b1<-ggplot(df, aes(x=i, y=value)) + geom_boxplot(aes(fill=variable),outlier.size=0.5)+
   scale_fill_brewer(palette="Spectral")+
    #stat_summary(fun="mean", geom = "point", shape=23, size =3, fill="pink")+ 
    xlab("Error Type")+ylab("Per-iteration Average Length")
  return(b1)
}
a<-plotbp2(meltedf12)
b<-plotbp2(meltedf22)
c<-plotbp2(meltedf32)
d<-plotbp2(meltedf42)
e<-plotbp2(meltedf52)

plot_grid(
  a, b,c,d,e,
  align = "h", axis = "tb",
  nrow = 3, rel_widths = c(2,2)
)

###Average Length and Avg coverage by Sample Size & model type 
##So na,nb,n1,n2,n3,n4 for each alg
#########################################################################
#########################################################################

##na,nb,n1,n2,n3,n4
#n<-0.2*50

###PER-ITERATION AVERAGE COVERAGE PLOT 
for (i in 16:30){
  g<-data.frame(na[i])
  gb<-data.frame(nb[i])
  gc<-data.frame(n1[i])
  gd<-data.frame(n2[i])
  ge<-data.frame(n3[i])
  gf<-data.frame(n4[i])
  n0<-nrow(g)/1000
  n01<-nrow(gb)/1000
  n02<-nrow(gc)/1000
  n03<-nrow(gd)/1000
  n04<-nrow(ge)/1000
  n05<-nrow(gf)/1000
  g1<-data.frame(aggregate(g, list(rep(1:(nrow(g) %/% n0 + 1), each = n0, len = nrow(g))), mean)[-1])
  g2<-data.frame(aggregate(gb, list(rep(1:(nrow(gb) %/% n01 + 1), each = n01, len = nrow(gb))), mean)[-1])
  g3<-data.frame(aggregate(gc, list(rep(1:(nrow(gc) %/% n02 + 1), each = n02, len = nrow(gc))), mean)[-1])
  g4<-data.frame(aggregate(gd, list(rep(1:(nrow(gd) %/% n03 + 1), each = n03, len = nrow(gd))), mean)[-1])
  g5<-data.frame(aggregate(ge, list(rep(1:(nrow(ge) %/% n04 + 1), each = n04, len = nrow(ge))), mean)[-1])
  g6<-data.frame(aggregate(gf, list(rep(1:(nrow(gf) %/% n05 + 1), each = n05, len = nrow(gf))), mean)[-1])
  g1$type<-g2$type<-g3$type<-g4$type<-g5$type<-g6$type<-i-15
  g1$sample<-as.character(nrow(g)/(1000*0.2))
  g2$sample<-as.character(nrow(gb)/(1000*0.2))
  g3$sample<-as.character(nrow(gc)/(1000*0.2))
  g4$sample<-as.character(nrow(gd)/(1000*0.2))
  g5$sample<-as.character(nrow(ge)/(1000*0.2))
  g6$sample<-as.character(nrow(gf)/(1000*0.2))
  names(g1)<-names(g2)<-names(g3)<-names(g4)<-names(g5)<-names(g6)<-c("DCP-QR","DCP-opt",
                    "CQR","CQR-m","CQR-r","CP-reg","i","Sample")
  assign(paste("ec50",i,sep=""),g1)
  assign(paste("ec70",i,sep=""),g2)
  assign(paste("ec100",i,sep=""),g3)
  assign(paste("ec200",i,sep=""),g4)
  assign(paste("ec300",i,sep=""),g5)
  assign(paste("ecfive",i,sep=""),g6)
}

##Isolating only for DCP-QR columns
new_df0 <- do.call("rbind",mget(ls(pattern = "^ec50*"))) ##
new_df1 <- do.call("rbind",mget(ls(pattern = "^ec70*")))
new_df2 <- do.call("rbind",mget(ls(pattern = "^ec100*")))
new_df3 <- do.call("rbind",mget(ls(pattern = "^ec200*")))
new_df4 <- do.call("rbind",mget(ls(pattern = "^ec300*")))
new_df5 <- do.call("rbind",mget(ls(pattern = "^ecfive*")))

##Isolate for first and last 2 columns for DCP
isol_bp<-function(k){
dfc<-rbind.data.frame(new_df0[,c(k,7,8)],new_df1[,c(k,7,8)],new_df2[,c(k,7,8)],
                      new_df3[,c(k,7,8)],new_df4[,c(k,7,8)],new_df5[,c(k,7,8)])
dfc$i<-as.character(dfc$i)
names(dfc)<-c("Method","i","Sample")

dfc$i<-factor(dfc$i,
              levels=c("1","2","3","4","5",
                       "6","7","8","9","10",
                       "11","12","13","14","15"))

dfc$Sample<-factor(dfc$Sample,
                    levels=c("50","70","100",
                             "200","300","500"))
a<-ggplot(data=dfc,
       aes(x=Sample,y=Method))+
  geom_boxplot(outlier.size=0.75,varwidth=T)+facet_wrap(~i)+
  geom_hline(yintercept=0.9,col="red")+xlab("Sample Size")+
  ylab("Per-iteration Average Coverage")
  #geom_line(data = mean,mapping = aes(x =Sample, y = average, group=1),
            #color="red", size=1.4)
return(a)

}
a<-isol_bp(1)
b<-isol_bp(2)
c<-isol_bp(3)
d<-isol_bp(4)
e<-isol_bp(5)
f<-isol_bp(6)

####PER ITERATION AVERAGE LENGTH PLOT
for (i in 1:15){
  g<-data.frame(na[i])
  gb<-data.frame(nb[i])
  gc<-data.frame(n1[i])
  gd<-data.frame(n2[i])
  ge<-data.frame(n3[i])
  gf<-data.frame(n4[i])
  n0<-nrow(g)/1000
  n01<-nrow(gb)/1000
  n02<-nrow(gc)/1000
  n03<-nrow(gd)/1000
  n04<-nrow(ge)/1000
  n05<-nrow(gf)/1000
  g1<-data.frame(aggregate(g, list(rep(1:(nrow(g) %/% n0 + 1), each = n0, len = nrow(g))), mean)[-1])
  g2<-data.frame(aggregate(gb, list(rep(1:(nrow(gb) %/% n01 + 1), each = n01, len = nrow(gb))), mean)[-1])
  g3<-data.frame(aggregate(gc, list(rep(1:(nrow(gc) %/% n02 + 1), each = n02, len = nrow(gc))), mean)[-1])
  g4<-data.frame(aggregate(gd, list(rep(1:(nrow(gd) %/% n03 + 1), each = n03, len = nrow(gd))), mean)[-1])
  g5<-data.frame(aggregate(ge, list(rep(1:(nrow(ge) %/% n04 + 1), each = n04, len = nrow(ge))), mean)[-1])
  g6<-data.frame(aggregate(gf, list(rep(1:(nrow(gf) %/% n05 + 1), each = n05, len = nrow(gf))), mean)[-1])
  g1$type<-g2$type<-g3$type<-g4$type<-g5$type<-g6$type<-i
  g1$sample<-as.character(nrow(g)/(1000*0.2))
  g2$sample<-as.character(nrow(gb)/(1000*0.2))
  g3$sample<-as.character(nrow(gc)/(1000*0.2))
  g4$sample<-as.character(nrow(gd)/(1000*0.2))
  g5$sample<-as.character(nrow(ge)/(1000*0.2))
  g6$sample<-as.character(nrow(gf)/(1000*0.2))
  names(g1)<-names(g2)<-names(g3)<-names(g4)<-names(g5)<-names(g6)<-c("DCP-QR","DCP-opt",
                                                                      "CQR","CQR-m","CQR-r","CP-reg","i","Sample")
  assign(paste("el50",i,sep=""),g1)
  assign(paste("el70",i,sep=""),g2)
  assign(paste("el100",i,sep=""),g3)
  assign(paste("el200",i,sep=""),g4)
  assign(paste("el300",i,sep=""),g5)
  assign(paste("elfive",i,sep=""),g6)
}

##Isolating only for DCP-QR columns
new_dfl0 <- do.call("rbind",mget(ls(pattern = "^el50*"))) ##
new_dfl1 <- do.call("rbind",mget(ls(pattern = "^el70*")))
new_dfl2 <- do.call("rbind",mget(ls(pattern = "^el100*")))
new_dfl3 <- do.call("rbind",mget(ls(pattern = "^el200*")))
new_dfl4 <- do.call("rbind",mget(ls(pattern = "^el300*")))
new_dfl5 <- do.call("rbind",mget(ls(pattern = "^elfive*")))

##Isolate for first and last 2 columns for DCP
isol_bp2<-function(k,s){
  dfc<-rbind.data.frame(new_dfl0[,c(k,7,8)],new_dfl1[,c(k,7,8)],new_dfl2[,c(k,7,8)],
                        new_dfl3[,c(k,7,8)],new_dfl4[,c(k,7,8)],new_dfl5[,c(k,7,8)])
  names(dfc)<-c("Method","i","Sample")
  
  dfc$Sample<-factor(dfc$Sample,
                     levels=c("50","70","100",
                              "200","300","500"))
  
  g<-dfc%>%filter(i==s)
  a<-ggplot(data=g,
         aes(x=Sample,y=Method))+geom_boxplot()+xlab("Sample Size")+
    ylab("Per-iteration Average Length")+
    stat_summary(fun=match.fun(mean), geom="point", shape=20, size=3, color="red",
                 position = position_dodge2(width = 0.75,   
                                            preserve = "single"))+
    stat_summary(fun = match.fun(mean), geom = "text", col = "red",     # Add text to plot
                 vjust = 1.5, aes(label = paste(round(..y.., digits = 3))))
  return(a)
} 

isol_bp3<-function(k,s){
  dfc<-rbind.data.frame(new_dfl0[,c(k,7,8)],new_dfl1[,c(k,7,8)],new_dfl2[,c(k,7,8)],
                        new_dfl3[,c(k,7,8)],new_dfl4[,c(k,7,8)],new_dfl5[,c(k,7,8)])
  names(dfc)<-c("Method","i","Sample")
  
  dfc$Sample<-factor(dfc$Sample,
                     levels=c("50","70","100",
                              "200","300","500"))
  
  g<-dfc%>%filter(i==s)
  g2<-g%>%group_by(Sample) %>%
    dplyr::summarize(Mean = mean(Method, na.rm=TRUE))
  g2<-data.frame(g2)
  return(g2)
} 
###Model 1
a<-isol_bp2(1,1)
b<-isol_bp2(2,1)
c<-isol_bp2(3,1)
d<-isol_bp2(4,1)
e<-isol_bp2(5,1)
f<-isol_bp2(6,1)

###Model 2
a2<-isol_bp2(1,2)
b2<-isol_bp2(2,2)
c2<-isol_bp2(3,2)
d2<-isol_bp2(4,2)
e2<-isol_bp2(5,2)
f2<-isol_bp2(6,2)

##Model-3
a3<-isol_bp2(1,3)
b3<-isol_bp2(2,3)
c3<-isol_bp2(3,3)
d3<-isol_bp2(4,3)
e3<-isol_bp2(5,3)
f3<-isol_bp2(6,3)

plot_grid(
  a, b,c,d,e,f,
  a2,b2,c2,d2,e2,f2,
  a3,b3,c3,d3,e3,f3,
 # a4,b4,c4,d4,e4,f4,
  #a5,b5,c5,d5,e5,f5,
  align = "h", axis = "tb",
  nrow = 3, rel_widths = c(2,2)
)

install.packages("gridExtra")
library(gridExtra)
# arrange plots in grid
grid.arrange(arrangeGrob(a,b,c,d,e,f, ncol=6, nrow=1),
             arrangeGrob(a2,b2,c2,d2,e2,f2,ncol=6,nrow=2),
             arrangeGrob(a3,b3,c3,d3,e3,f3,ncol=6,nrow=3),
             arrangeGrob(a4,b4,c4,d4,e4,f4,ncol=6,nrow=4),
             arrangeGrob(a5,b5,c5,d5,e5,f5,ncol=6,nrow=5))

grid.arrange(arrangeGrob(plot1, plot2, ncol=2, nrow=1), 
             plot3, nrow=2
             #, environment = environment()
)

##Model-4
a4<-isol_bp2(1,4)
b4<-isol_bp2(2,4)
c4<-isol_bp2(3,4)
d4<-isol_bp2(4,4)
e4<-isol_bp2(5,4)
f4<-isol_bp2(6,4)

##Model-5
a5<-isol_bp2(1,5)
b5<-isol_bp2(2,5)
c5<-isol_bp2(3,5)
d5<-isol_bp2(4,5)
e5<-isol_bp2(5,5)
f5<-isol_bp2(6,5)

##Model-6
a6<-isol_bp2(1,6)
b6<-isol_bp2(2,6)
c6<-isol_bp2(3,6)
d6<-isol_bp2(4,6)
e6<-isol_bp2(5,6)
f6<-isol_bp2(6,6)

##Model-7
a7<-isol_bp2(1,7)
b7<-isol_bp2(2,7)
c7<-isol_bp2(3,7)
d7<-isol_bp2(4,7)
e7<-isol_bp2(5,7)
f7<-isol_bp2(6,7)

##Model-8
a8<-isol_bp2(1,8)
b8<-isol_bp2(2,8)
c8<-isol_bp2(3,8)
d8<-isol_bp2(4,8)
e8<-isol_bp2(5,8)
f8<-isol_bp2(6,8)

##Model-9
a9<-isol_bp2(1,9)
b9<-isol_bp2(2,9)
c9<-isol_bp2(3,9)
d9<-isol_bp2(4,9)
e9<-isol_bp2(5,9)
f9<-isol_bp2(6,9)

##Model-10
a10<-isol_bp2(1,10)
b10<-isol_bp2(2,10)
c10<-isol_bp2(3,10)
d10<-isol_bp2(4,10)
e10<-isol_bp2(5,10)
f10<-isol_bp2(6,10)

##Model-11
a11<-isol_bp2(1,11)
b11<-isol_bp2(2,11)
c11<-isol_bp2(3,11)
d11<-isol_bp2(4,11)
e11<-isol_bp2(5,11)
f11<-isol_bp2(6,11)


##Model-12
a12<-isol_bp2(1,12)
b12<-isol_bp2(2,12)
c12<-isol_bp2(3,12)
d12<-isol_bp2(4,12)
e12<-isol_bp2(5,12)
f12<-isol_bp2(6,12)


##Model-13
a13<-isol_bp2(1,13)
b13<-isol_bp2(2,13)
c13<-isol_bp2(3,13)
d13<-isol_bp2(4,13)
e13<-isol_bp2(5,13)
f13<-isol_bp2(6,13)


##Model-14
a14<-isol_bp2(1,14)
b14<-isol_bp2(2,14)
c14<-isol_bp2(3,14)
d14<-isol_bp2(4,14)
e14<-isol_bp2(5,14)
f14<-isol_bp2(6,14)

##Model-15
a15<-isol_bp2(1,15)
b15<-isol_bp2(2,15)
c15<-isol_bp2(3,15)
d15<-isol_bp2(4,15)
e15<-isol_bp2(5,15)
f15<-isol_bp2(6,15)

























































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































plot_grid(
  
  align = "h", axis = "tb",
  nrow = 1, rel_widths = c(2,2)
)



plot_grid(
  a,b,c,d,e,f,
  align="h",axis="tb",
  nrow=1,rel_widths=c(2,2)
)



  #a<-ggplot(data=dfc,
   #         aes(x=Sample,y=Method))+
    #geom_boxplot(outlier.size=0.75,varwidth=T)+facet_wrap(~i)+
    #geom_hline(yintercept=0.9,col="red")+xlab("Sample Size")+
    #ylab("Per-iteration Average Length")
  #geom_line(data = mean,mapping = aes(x =Sample, y = average, group=1),
  #color="red", size=1.4)
  
  


a1<-isol_bp2(1)
b1<-isol_bp2(2)
c1<-isol_bp2(3)
d1<-isol_bp2(4)
e1<-isol_bp2(5)
f1<-isol_bp2(6)






ndcp<-new_df0[,c(1,7,8)]
ndcp1<-new_df1[,c(1,7,8)]
ndcp2<-new_df2[,c(1,7,8)]
ndcp3<-new_df3[,c(1,7,8)]
ndcp4<-new_df4[,c(1,7,8)]
ndcp5<-new_df5[,c(1,7,8)]

newd<-do.call("rbind",mget(ls(pattern="^ndcp*")))
newd$i<-as.character(newd$i)
names(newd)<-c("Method","i","Sample")

newd$i<-factor(newd$i,
        levels=c("1","2","3","4","5",
        "6","7","8","9","10",
        "11","12","13","14","15"))

newd$Sample<-factor(newd$Sample,
               levels=c("50","70","100",
                "200","300","500"))
ggplot(data = newd,
       aes(x = i, y = Method, fill = factor(Sample))) +
  geom_boxplot(outlier.size = 1) + 
  #stat_summary(fun = mean, color = "darkred", position = position_dodge(0.75),
   #            geom = "point", shape = 18, size = 2,
    #           show.legend = FALSE)+
  scale_fill_brewer(palette="Spectral")

odcp<-new_df0[,c(2,7,8)]
odcp1<-new_df1[,c(2,7,8)]
odcp2<-new_df2[,c(2,7,8)]
odcp3<-new_df3[,c(2,7,8)]
odcp4<-new_df4[,c(2,7,8)]
odcp5<-new_df5[,c(2,7,8)]

newd<-do.call("rbind",mget(ls(pattern="^odcp*")))
newd$i<-as.character(newd$i)
names(newd)<-c("Method","i","Sample")

newd$i<-factor(newd$i,
               levels=c("1","2","3","4","5",
                        "6","7","8","9","10",
                        "11","12","13","14","15"))

newd$Sample<-factor(newd$Sample,
                    levels=c("50","70","100",
                             "200","300","500"))

ggplot(data=newd,
       aes(x=Sample,y=Method))+
  geom_boxplot(outlier.size=0.75,varwidth=T)+facet_wrap(~i)+
  geom_hline(yintercept=0.9,col="red")+
  #geom_line(data = mean,mapping = aes(x =Sample, y = average, group=1),
   #         color="red", size=1)+
  scale_fill_brewer(palette="Spectral")


mean <- newd %>% 
  group_by(Sample) %>% 
  summarize(average = mean(Method)) %>%
  ungroup()

ggplot(data=newd,
       aes(x=Sample,y=Method))+
  geom_boxplot(outlier.size=0.75,varwidth=T)+facet_wrap(~i)+
  geom_hline(yintercept=0.9,col="red")+
  geom_line(data = mean,mapping = aes(x =Sample, y = average, group=1),
            color="red", size=1.4)




bd<-function(){
  for (i in 1:){
    d<-
  }
}

##Now get boxplots
d%>%filter(i=="1")


n<-0.2*70
for (i in 16:30){
  g<-data.frame(nb[i])
  g1<-data.frame(aggregate(g, list(rep(1:(nrow(g) %/% n + 1), each = n, len = nrow(g))), mean)[-1])
  g1$type<-i-15
  g1$type<-as.character(g1$type)
  g1a<-cbind.data.frame(g1[,1],type,"DCP-QR-70")
  names(g1a)<-c("DCP-QR","i","method")
  g1b<-cbind.data.frame(g1[,2],type,"DCP-opt-70")
  names(g1b)<-c("DCP-opt","i","method")
  g1c<-cbind.data.frame(g1[,3],type,"CQR-70")
  names(g1c)<-c("CQR","i","method")
  g1d<-cbind.data.frame(g1[,4],type,"CQR-m-70")
  names(g1d)<-c("CQR-m","i","method")
  g1e<-cbind.data.frame(g1[,5],type,"CQR-r-70")
  names(g1e)<-c("CQR-r","i","method")
  g1f<-cbind.data.frame(g1[,6],type,"CP-reg-70")
  names(g1f)<-c("CP-reg","i","method")
  assign(paste("dcpqr70",i,sep=""),g1a)
  assign(paste("dcpo70",i,sep=""),g1b)
  assign(paste("cqr70",i,sep=""),g1c)
  assign(paste("cqrm70",i,sep=""),g1d)
  assign(paste("cqrr70",i,sep=""),g1e)
  assign(paste("cpreg70",i,sep=""),g1f)
}

new_df <- do.call("rbind",mget(ls(pattern = "^dcpqr*")))
new_df$i<-as.character(new_df$i)
meltedn <- melt(new_df, id.var=c("i","method"))

plotbp2<-function(df){
  b1<-ggplot(meltedn, aes(x=i, y=value)) + geom_boxplot(aes(fill=method),outlier.size=0.5)+
    scale_fill_brewer(palette="Spectral")+
    #stat_summary(fun="mean", geom = "point", shape=23, size =3, fill="pink")+ 
    xlab("Error Type")+ylab("Per-iteration Average Length")
  return(b1)
}
#df_three <- rbind(DCPQR5016,DCPQR5017,DCPQR5018,DCPQR7016,DCPQR7017,DCPQR7018)
#df_six <- rbind()
#df_nine <- rbind(EC22,EC23,EC24)
#df_twelve <- rbind(EC25,EC26,EC27)
#df_fifteen <- rbind(EC28,EC29,EC30)


n<-0.2*100
for (i in 16:30){
  g<-data.frame(n1[i])
  g1<-data.frame(aggregate(g, list(rep(1:(nrow(g) %/% n + 1), each = n, len = nrow(g))), mean)[-1])
  g1$type<-i-15
  g1$type<-as.character(g1$type)
  names(g1)<-c("DCP-QR","DCP-opt","CQR","CQR-m","CQR-r","CP-reg","i")
  assign(paste("EC",i,sep=""),g1)
}










#ec<-function(md,n){
  
  #return(k)


#ec(n4,100)

#sv0<-NULL
#empcov<-function(n,m,s){
  
 # for (i in 1:s){
  #  subval<-m[n*(i-1)+1:n*i,]
   # subval_avg<-colMeans(subval,na.rm=TRUE)
  #  sv0<-rbind(sv0,subval_avg)
  #}
#return(sv0)
#}  ##works

#sv<-list()
##put empcov in another function
#empcov2<-function(n,m,s){
 
 # for (j in 1:15){
  #     dat<-m[j+15]
   #    cover<-empcov(n,data.frame(dat),s)
    #   sv[[j]]<-cover
     #  }
  #return(sv)
}
##So each element of sv gives the average coverage per iteration for each model
##Now we plot it 

#e4<-empcov2(100,n4,1000)

#for (i in 1:15){
 # df<-data.frame(e4[i])
  #df$i<-i
  #df$i<-as.character(df$i)
  #names(df)<-c("DCP-QR","DCP-opt","CQR","CQR-m","CQR-r","CP-reg","i")
  
  # create a data frame to hold results
  #assign(paste('N500_',i,sep=''),df)
#}

##Now have 15 dataframes for 15 models
##Create boxplots 


###Why are NA values being created that are being dropped? Debug.



##Then we do the same for length



##What about average length and coverage by sample size?  



##quantile bins

##na-10 nb-14 n1: 20 n2: 40 n3: 60 n4: 100
ec<-function(md,rowsam){
e<-NULL
for (i in 16:30){
     empcov(rowsam,data.frame(md[i]),1000)
     e<-rbind(e,empcov)
}
return(e)
}

plotfunc<-function(k,dat,n,it){
  x<-data.frame(dat[k])
  x<-empcov(n,x,it)
  #dat2<-read.xlsx("")
  #x1<-data.frame(apply(dat2,1,function(x){sum(x)/n}))
  #x2<-data.frame(apply(dat3,1,function(x){sum(x)/n}))
  dat4<-data.frame(x)
  names(dat4)<-c("DCP","DCP-opt","CQR","CQR-m","CQR-r","CP-reg")
  #dat4<-dat4[,which(apply(dat4,2,var)!=0)] ##removing columns with constant values
  dat5<-melt(dat4)
  dat5<-na.omit(dat5)
  theme_set(theme_gray(base_size = 20))
  plotg<-ggplot(data = dat5, aes(x = variable, y = value))
  plotg2<-plotg+geom_boxplot()+labs(x = "Method", y = "Average Coverage/iteration")+
    geom_hline(yintercept=0.9,col="red",size=0.75)
  return(plotg2)
}

###Also predicted coverage probability

###Also quantile bins

##Avg length and coverage for each algorithm separately by sample size


n5<-normal(700)

##
n6<-normal(1000)

o1<-other(100)
sink("o1.text")
o1
sink()
o2<-other(200)
o3<-other(300)
o4<-other(500)
o5<-other(700)

sink("n1.txt")
n1
sink()

sink("n2.txt")
n2
sink()

sink("n3.txt")
n3
sink()

sink("n4.txt")
n4
sink()

sink("n5.txt")
n5
sink()


sink("n6.txt")
n6
sink()

##exporting normal results to python 
na,nb,n1,n2,n3,n4  ##generate data with seed and export to python
##

##na
k1<-na[1:15]
k1a<-data.frame(na[1:15])  ##coverage

kla<-data.frame(na[16:30])  ##length
ksa<-data.frame(na[31:46])  ##41 is duplicate of 40  ##conditional prob sd
write_xlsx(k1a,"k1a50.xlsx")
write_xlsx(kla,"kla50l.xlsx")
write_xlsx(ksa,"ksa50.xlsx")

##nb
k1b<-data.frame(nb[1:15])  ##coverage

ktb<-data.frame(nb[16:30])  ##length
ksb<-data.frame(nb[31:46])
write_xlsx(k1b,"k1b70.xlsx")
write_xlsx(ktb,"ktb70.xlsx")
write_xlsx(ksb,"ksb70.xlsx")

##
k11<-data.frame(n1[1:15])  ##coverage

kt1<-data.frame(n1[16:30])  ##length
ks1<-data.frame(n1[31:46])
write_xlsx(k11,"k1100.xlsx")
write_xlsx(kt1,"kt100.xlsx")
write_xlsx(ks1,"ks100.xlsx")

k12<-data.frame(n2[1:15])  ##coverage

kt2<-data.frame(n2[16:30])  ##length
ks2<-data.frame(n2[31:46])
write_xlsx(k12,"k1200.xlsx")
write_xlsx(kt2,"kt200.xlsx")
write_xlsx(ks2,"ks200.xlsx")

k13<-data.frame(n3[1:15])  ##coverage

kt3<-data.frame(n3[16:30])  ##length
ks3<-data.frame(n3[31:46])
write_xlsx(k13,"k1300.xlsx")
write_xlsx(kt3,"kt300.xlsx")
write_xlsx(ks3,"ks300.xlsx")

k14<-data.frame(n4[1:15])  ##coverage

kt4<-data.frame(n4[16:30])  ##length
ks4<-data.frame(n4[31:45])
write_xlsx(k14,"k1400.xlsx")
write_xlsx(kt4,"kt400.xlsx")
write_xlsx(ks4,"ks400.xlsx")







###https://stats.stackexchange.com/questions/68596/model-fitting-when-errors-take-a-cauchy-distribution

